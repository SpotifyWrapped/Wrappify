{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account</title>
    <link rel="stylesheet" href="{% static 'spotify/account.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <a href="{% url 'profile' %}">
        <img src="{% static 'spotify/images/logo.png' %}" alt="Logo" class="logo">
    </a>

    <div class="top-section">
        {% if profile_image_url %}
            <img src="{{ profile_image_url }}" alt="Profile Picture" class="profile-image">
        {% else %}
            <img src="{% static 'images/pfp.png' %}" alt="Default Profile Picture" class="profile-image">
        {% endif %}
        <div class="name-and-link">
            <h1 class="username">{{ request.user.first_name }}</h1>
            {% if user_data.external_urls and user_data.external_urls.spotify %}
                <p><a href="{{ user_data.external_urls.spotify }}" class="spotify-link">Open in Spotify</a></p>
            {% endif %}
        </div>
    </div>

    <div class="content">
        <div class="spotify-account">
            <h1 class="account-title">Spotify Account</h1>
            <p class="account-description">The Spotify account that you're signed in with.</p>
            <div class="account-details">
                <p><span class="field-title">Username:</span> <span class="field-value">{{ request.user.first_name }}</span></p>
                <p><span class="field-title">Email:</span> <span class="field-value">{{ request.user.email }}</span></p>
            </div>
        </div>

        <div class="delete-account">
            <h1 class="delete-title">Delete Wrappify Account</h1>
            <p class="delete-description">This will permanently delete your account.</p>
            <form action="{% url 'delete_account' %}" method="POST" id="delete-account-form" class="delete-account-form">
                {% csrf_token %}
                <button type="button" class="delete-button" onclick="confirmDelete()">Delete Account</button>
                <script>
                    function confirmDelete() {
                        const userConfirmed = confirm("Are you sure you want to delete this account? This action cannot be undone.");
                        if (userConfirmed) {
                            const form = document.getElementById('delete-account-form');
                            fetch(form.action, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                                },
                                body: new FormData(form),
                            })
                                .then(response => {
                                    if (response.ok) {
                                        alert("Account Successfully Deleted");
                                        window.location.href = "{% url 'login' %}"; 
                                    } else {
                                        alert("Something went wrong. Please try again.");
                                    }
                                })
                                .catch(error => {
                                    console.error("Error:", error);
                                    alert("Failed to delete account. Please try again.");
                                });
                        }
                    }
                </script>
            </form>
        </div>
    </div>

    <div class="home">
        <a href="{% url 'profile' %}" class="home-button">Back Home</a>
    </div>
</body>
</html>
